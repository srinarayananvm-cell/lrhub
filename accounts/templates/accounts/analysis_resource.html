{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'student_dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'student_dashboard' %}?tab=resources{% if query %}&q={{ query }}{% endif %}">Resources</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Analyze Resource: {{ resource.title }}
            </li>
        </ol>
    </nav>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Analyze Resource: {{ resource.title }}</h4>
        </div>
        <div class="card-body">
            <!-- Topic input -->
            <div class="mb-3">
                <label for="queryInputRes" class="form-label fw-bold">Enter Topic</label>
                <input type="text" id="queryInputRes" class="form-control" placeholder="Type a topic to analyze">
            </div>

            <!-- Analysis button -->
            <button id="analyzeBtnRes" class="btn btn-success mb-3">üîç Analyze</button>

            <!-- Result area -->
            <div id="analysisResultRes" class="alert alert-secondary analysis-result">
                Result will appear here...
            </div>

            <!-- ‚úÖ Summarize button -->
            <button id="summarizeBtnRes" class="btn btn-info mb-3">üìù Summarize Resource</button>
            <div id="summaryResultRes" class="alert alert-secondary mt-2">
                Summary will appear here...
            </div>

            <!-- Download button -->
            <a href="{% url 'download_student_resource' resource.id %}" class="btn btn-primary mt-2">
                ‚¨áÔ∏è Download Resource
            </a>
        </div>
    </div>
</div>

<!-- Safe JSON injection -->
{{ resource.id|json_script:"resourceId" }}

<script>
document.addEventListener("DOMContentLoaded", function() {
    const resourceId = JSON.parse(document.getElementById("resourceId").textContent);
    const analyzeBtn = document.getElementById("analyzeBtnRes");
    const resultDiv = document.getElementById("analysisResultRes");
    const summarizeBtn = document.getElementById("summarizeBtnRes");
    const summaryDiv = document.getElementById("summaryResultRes");

    // ‚úÖ Prevent auto-dismiss for analysis alert
    resultDiv.addEventListener("close.bs.alert", function (event) {
        if (resultDiv.classList.contains("analysis-result")) {
            event.preventDefault();
        }
    });

    // ‚úÖ Prevent auto-dismiss for summary alert
    summaryDiv.addEventListener("close.bs.alert", function (event) {
        event.preventDefault();
    });

    // Analyze button logic
    analyzeBtn.addEventListener("click", function() {
        const query = document.getElementById("queryInputRes").value.trim();
        if (!query) {
            resultDiv.className = "alert alert-danger analysis-result";
            resultDiv.innerText = "‚ùå Please enter a topic before analyzing.";
            return;
        }
        resultDiv.className = "alert alert-info analysis-result";
        resultDiv.innerText = "‚è≥ Analyzing...";
        fetch(`/api/accounts/analyze/resource/${resourceId}/?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                if (data.suggestion === "related") {
                    resultDiv.className = "alert alert-success analysis-result";
                    resultDiv.innerText = `‚úÖ Related\nScore: ${data.relevance_score}\nBest Match: ${data.best_match}`;
                } else {
                    resultDiv.className = "alert alert-danger analysis-result";
                    resultDiv.innerText = `‚ùå Not Related\nScore: ${data.relevance_score}\nBest Match: ${data.best_match}`;
                }
            })
            .catch(error => {
                resultDiv.className = "alert alert-danger analysis-result";
                resultDiv.innerText = "‚ùå Error during analysis. Please try again.";
                console.error(error);
            });
    });

    // Summarize button logic
    summarizeBtn.addEventListener("click", function() {
        summaryDiv.className = "alert alert-info";
        summaryDiv.innerText = "‚è≥ Summarizing...";
        fetch(`/resources/pdf/resource/${resourceId}/summarize/`)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                summaryDiv.className = "alert alert-success";
                summaryDiv.innerText = data.summary;
            })
            .catch(error => {
                summaryDiv.className = "alert alert-danger";
                summaryDiv.innerText = "‚ùå Error generating summary.";
                console.error(error);
            });
    });
});
</script>
{% endblock %}
