{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'student_dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'student_dashboard' %}#notes">Notes</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Analyze Note: {{ note.title }}
            </li>
        </ol>
    </nav>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Analyze Note: {{ note.title }}</h4>
        </div>
        <div class="card-body">
            <!-- Topic input -->
            <div class="mb-3">
                <label for="queryInput" class="form-label fw-bold">Enter Topic</label>
                <input type="text" id="queryInput" class="form-control" placeholder="Type a topic to analyze">
            </div>

            <!-- Analysis button -->
            <button id="analyzeBtn" class="btn btn-success mb-3">üîç Analyze</button>

            <!-- Result area -->
            <div id="analysisResult" class="alert alert-secondary analysis-result">
                Result will appear here...
            </div>

            <!-- ‚úÖ Summarize button -->
            <button id="summarizeBtn" class="btn btn-info mb-3">üìù Summarize Note</button>
            <div id="summaryResult" class="alert alert-secondary mt-2">
                Summary will appear here...
            </div>

            <!-- Download button -->
            <a href="{% url 'download_note' note.id %}" class="btn btn-primary mt-2">
                ‚¨áÔ∏è Download Note
            </a>
        </div>
    </div>
</div>

<!-- Safe JSON injection -->
{{ note.id|json_script:"noteId" }}

<script>
document.addEventListener("DOMContentLoaded", function() {
    const noteId = JSON.parse(document.getElementById("noteId").textContent);
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultDiv = document.getElementById("analysisResult");
    const summarizeBtn = document.getElementById("summarizeBtn");
    const summaryDiv = document.getElementById("summaryResult");

    // Prevent auto-dismiss for analysis alert
    resultDiv.addEventListener("close.bs.alert", function (event) {
        if (resultDiv.classList.contains("analysis-result")) {
            event.preventDefault();
        }
    });

    // Prevent auto-dismiss for summary alert
    summaryDiv.addEventListener("close.bs.alert", function (event) {
        event.preventDefault();
    });

    analyzeBtn.addEventListener("click", function() {
        const query = document.getElementById("queryInput").value.trim();
        if (!query) {
            resultDiv.className = "alert alert-danger analysis-result";
            resultDiv.innerText = "‚ùå Please enter a topic before analyzing.";
            return;
        }
        resultDiv.className = "alert alert-info analysis-result";
        resultDiv.innerText = "‚è≥ Analyzing...";
        fetch(`/api/accounts/analyze/note/${noteId}/?query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                resultDiv.className = "alert alert-success analysis-result";
                resultDiv.innerText = `Score: ${data.relevance_score} | Suggestion: ${data.suggestion}`;
            })
            .catch(() => {
                resultDiv.className = "alert alert-danger analysis-result";
                resultDiv.innerText = "‚ùå Error during analysis. Please try again.";
            });
    });

    summarizeBtn.addEventListener("click", function() {
        summaryDiv.className = "alert alert-info";
        summaryDiv.innerText = "‚è≥ Summarizing...";
        fetch(`/resources/pdf/note/${noteId}/summarize/`)
            .then(res => res.json())
            .then(data => {
                summaryDiv.className = "alert alert-success";
                summaryDiv.innerText = data.summary;
            })
            .catch(() => {
                summaryDiv.className = "alert alert-danger";
                summaryDiv.innerText = "‚ùå Error generating summary.";
            });
    });
});
</script>
{% endblock %}
